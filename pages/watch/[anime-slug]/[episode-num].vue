<template>
  <div class="cont relative my-20 items-stretch" v-if="episode">
    <div class="episode">
      <Player v-if="!!sources" :episode="episode" :anime="anime" :sources="sources" class="relative w-full aspect-video mb-8" />
      <div v-else>
        Loading player
      </div>
      <div class="m-2">
        <nuxt-link :href="`/anime/` + anime.slug"><span class="text-3xl">{{ preferredTitle }}</span></nuxt-link>
        <p class="text-xl text-tertiary">Episode {{ number }}<span v-if="title" class="p-0">: {{ title }}
          </span>
        </p>
      </div>
    </div>
    <div class="list flex-1 pl-10 inline-flex flex-col items-start justify-start m-0 p-0 h-full">
      <span class="text-3xl mb-4 pl-3 m-0">Episodes</span>
      <div class="line"></div>
      <div ref="next-eps" class="flex flex-col py-3 p-0 m-0 justify-start overflow-y-auto flex-grow">
        <nuxt-link no-prefetch ref="episodeRefs" v-for="(ep, index) in animeeps" :key="ep.id" :to="`/watch/${anime.slug}/${ep.number}`"
                   class="next-ep p-1 m-1 px-3 m-0 text-tertiary max-h-16" :class="ep.number === number ? 'cur':''">
          <p class="text-xl text-overflow">Episode {{ ep.number }}<span v-if="ep.title">: {{
              ep.title }}</span></p>
        </nuxt-link>
      </div>
      <div class="line"></div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { definePageMeta, nextTick, onMounted, ref, watch, watchEffect } from '#imports';
import { navigateTo, useFetch, useHead, useRoute, useRuntimeConfig } from '#app';
import { createError } from 'h3';
import { gettitle } from 'assets/ts/helpers';
const runtimeConfig = useRuntimeConfig();

const route = useRoute();
const episodeRefs = ref([]);

const url = `${route.params.animeslug}/${route.params.episodenum}`;

definePageMeta({
  key: route => {
    return `/${route.params.animeslug}/${route.params.episodenum}`;
  }
});

const { error, data: episode } = await useFetch<{
  id: string,
  description: string | undefined,
  number: number,
  anime: {
    title: {
      english: string | undefined,
      romaji: string | undefined,
      native: string | undefined,
      userPreferred: string | undefined
    },
    slug: string,
    episodes: {
      number: number
    }[],
    bannerImage: string | undefined,
    coverImage: string | undefined,
    color: string | undefined
  },
  title: string | undefined,
  sources: object[],
  image: string | undefined,
  createdAt: Date | undefined
}>(`${runtimeConfig.public.enimeApi}/view/${url}`, {
  key: url
});

if (error.value || !episode.value) {
  throw createError({ statusCode: 404, message: "Episode not found" })
}

const { id, description, number, anime, title, sources, image, createdAt } = episode.value;

const animeeps = anime.episodes.sort((a, b) => a.number - b.number);
const preferredTitle = gettitle(anime.title);

useHead({
  title: `Episode ${number}${title ? ` - ${title}` : ""} | ${preferredTitle} | Enime`,
  meta: [
    {
      name: "og:title",
      content: `${preferredTitle} Episode ${number}`
    },
    {
      name: "og:type",
      content: "website"
    },
    {
      name: "og:url",
      content: `https://enime.moe/watch/${anime.slug}/${number}`
    },
    {
      name: "og:image",
      content: image || anime.bannerImage || anime.coverImage
    },
    {
      name: "og:description",
      content: `Watch ${preferredTitle} Episode ${number}${title ? ` - ${title}` : ""} online on Enime ${description ? `\n${description}` : ""}`
    },
    {
      name: "twitter:card",
      content: "summary_large_image"
    },
    {
      name: "theme-color",
      content: anime.color
    }
  ]
});

onMounted(() => {
  if (episodeRefs.value && number > 0 && number <= episodeRefs.value.length) {
    const current = episodeRefs.value[number - 1];

    if (current) current.$el.scrollIntoView({ behavior: "auto", block: "nearest" })
  }
})
</script>

<style scoped>
.cont {
  padding: 0 10vw;
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  aspect-ratio: 2/.8;
}
.episode {
  flex: 3;
}
.cur {
  background-color: #333;
  border-radius: 5px;
  color: #eee;
}
.line {
  width: 100%;
  height: 1px;
  background-color: #333;
}
.next-ep {
  white-space: normal;
  line-height: 1.75rem;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
}
.next-ep > p {
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  white-space: normal;
}
</style>
